---
import Card from "../layouts/Card.astro";
import Layout from "../layouts/Layout.astro";

import { getCollection, render } from "astro:content";
const posts = await getCollection("blog");

// `posts`` by itself isnt enough, it excludes reamark sutff (like read time),
// so we need to render/process every post to get this info.
// This could increase build time but I dont care, everything is pretty instant right now
const postsWithRenderedData = await Promise.all(
  posts.map(async (post) => {
    // Call render() on the entry. This runs the Remark plugins.
    const { remarkPluginFrontmatter } = await render(post);

    // Combine the original post data with the new injected frontmatter data from Remark plugins
    return {
      ...post,
      data: {
        ...post.data,
        // read_time: remarkPluginFrontmatter.minutesRead,
        read_time: remarkPluginFrontmatter.minutes,
      },
    };
  }),
);
// Sort posts by date, newest first
const sortedPosts = postsWithRenderedData.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});
---

<Layout>
  <div class="flex flex-col items-center gap-12 md:gap-8 px-4">
    {
      sortedPosts.map((post) => (
        <Card
          draft={post.data.draft}
          slug={post.data.slug || post.id}
          title={post.data.title}
          tags={post.data.tags}
          img_src={post.data.img_src}
          date={post.data.date}
          read_time={post.data.read_time}
          paragrafo={post.data.paragrafo}
        />
      ))
    }
  </div>
  <footer class="h-8"></footer>
</Layout>
