---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import ChevronDown from "../images/SVGs/chevron-down.svg";

const mobileFmt: Intl.DateTimeFormatOptions = {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
};
const desktopFmt: Intl.DateTimeFormatOptions = {
    year: "numeric",
    month: "short",
    day: "numeric",
};

const posts = await getCollection("blog");

const tags = [...new Set(posts.flatMap((post) => post.data.tags))].sort();

const postsByTag = tags.reduce(
    (acc, tag) => {
        acc[tag] = posts
            .filter((post) => post.data.tags.includes(tag))
            .sort(
                (a, b) =>
                    new Date(b.data.date).valueOf() -
                    new Date(a.data.date).valueOf(),
            );
        return acc;
    },
    {} as Record<string, typeof posts>,
);
---

<Layout title="Tags">
    <div
        class="max-w-4xl mx-auto md:px-8 md:pb-8 px-4 pt-0 pb-4 text-white min-h-screen"
    >
        <div class="bg-[#232323] rounded-lg shadow-lg overflow-hidden">
            {
                tags.map((tag, index) => (
                    <details
                        id={tag}
                        name="tags-accordion"
                        class="group border-b border-gray-700 last:border-b-0 scroll-mt-24"
                    >
                        <summary
                            class="cursor-pointer p-6 font-semibold text-trace-green
                        flex justify-between items-center list-none select-none 
                        hover:bg-white/5 transition-colors"
                        >
                            <a href={`#${tag}`} class="md:text-2xl text-xl ">
                                # {tag}
                            </a>
                            <ChevronDown class="w-6 h-6 flex-shrink-0 transition-transform duration-300 group-open:rotate-180" />
                        </summary>
                        <ul class="sm:px-12 pl-6 pr-3 pb-6 pt-0 space-y-3 bg-[#232323]">
                            {postsByTag[tag].map((post) => (
                                <li class="flex justify-between gap-3 sm:gap-4 mt-4 first:mt-2 ">
                                    <a
                                        href={`/blog/${post.id}`}
                                        class="sm:pr-10 text-base sm:text-lg hover:text-trace-green transition-colors  flex-1"
                                    >
                                        {post.data.title}
                                    </a>
                                    <time
                                        datetime={post.data.date.toISOString()}
                                        class="mt-auto text-xs sm:text-sm text-gray-400 font-mono flex-shrink-0 before:content-[attr(data-mobile)] md:before:content-[attr(data-desktop)]"
                                        data-mobile={post.data.date.toLocaleDateString(
                                            "en-GB",
                                            mobileFmt,
                                        )}
                                        data-desktop={post.data.date.toLocaleDateString(
                                            "en-GB",
                                            desktopFmt,
                                        )}
                                        aria-label={post.data.date.toLocaleDateString(
                                            "en-GB",
                                            desktopFmt,
                                        )}
                                    />
                                </li>
                            ))}
                        </ul>
                    </details>
                ))
            }
        </div>
    </div>
</Layout>

<script>
    // No idea why there is no native html solution for this,
    // but there also wasnt native html accordions, so i guess baby steps?
    const hash = window.location.hash;

    if (hash) {
        // Remove the '#' and decode URI to handle emojis and special characters
        // (emojis in URLs get encoded, e.g. ðŸŽ‰ becomes %F0%9F%8E%89)
        const elementId = decodeURIComponent(hash.slice(1));
        const element = document.getElementById(elementId);

        if (element && element.matches("details")) {
            // Open the accordion
            element.open = true;

            // Re-align the view (wait a tick to ensure styles applied)
            // This ensures the user sees the START of the opened accordion
            // (personally i dont 100% love this behavior but I dont want to pick a fight with SEO bots)
            element.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    }
</script>
